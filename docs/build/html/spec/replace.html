

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Replace &mdash; interBTC Specification  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Security" href="security.html" />
    <link rel="prev" title="Redeem" href="redeem.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: grey" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> interBTC Specification
          

          
          </a>

          
            
            
              <div class="version">
                v5.5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/at-a-glance.html">BTC Parachain at a Glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/CbA.html">Cryptocurrency-backed Assets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/polkadot.html">Polkadot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/xclaim-architecture.html">XCLAIM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/btcrelay-architecture.html">BTC-Relay Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/bitcoin.html">Bitcoin Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/accepted-format.html">Accepted Bitcoin Transaction Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">How to Read This Specification</a></li>
</ul>
<p class="caption"><span class="caption-text">XCLAIM Specification</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="collateral.html">Collateral</a></li>
<li class="toctree-l1"><a class="reference internal" href="fee.html">Fee</a></li>
<li class="toctree-l1"><a class="reference internal" href="oracle.html">Exchange Rate Oracle</a></li>
<li class="toctree-l1"><a class="reference internal" href="issue.html">Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="refund.html">Refund</a></li>
<li class="toctree-l1"><a class="reference internal" href="redeem.html">Redeem</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Replace</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-by-step">Step-by-Step</a></li>
<li class="toctree-l3"><a class="reference internal" href="#security">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vault-registry">Vault Registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fee-model">Fee Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#data-model">Data Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scalars">Scalars</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#replacebtcdustvalue">ReplaceBtcDustValue</a></li>
<li class="toctree-l4"><a class="reference internal" href="#replaceperiod">ReplacePeriod</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#maps">Maps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#replacerequests">ReplaceRequests</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#structs">Structs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Replace</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#functions">Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requestreplace">requestReplace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#specification">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#withdrawreplace">withdrawReplace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#acceptreplace">acceptReplace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#executereplace">executeReplace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">Specification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cancelreplace">cancelReplace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">Specification</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#events">Events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requestreplaceevent">RequestReplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#withdrawreplaceevent">WithdrawReplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acceptreplaceevent">AcceptReplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#executereplaceevent">ExecuteReplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cancelreplaceevent">CancelReplace</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#error-codes">Error Codes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="relay.html">Relay</a></li>
<li class="toctree-l1"><a class="reference internal" href="treasury.html">Treasury</a></li>
<li class="toctree-l1"><a class="reference internal" href="vault-registry.html">Vault Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="nomination.html">Vault Nomination</a></li>
<li class="toctree-l1"><a class="reference internal" href="reward.html">Reward</a></li>
<li class="toctree-l1"><a class="reference internal" href="staking.html">Staking</a></li>
</ul>
<p class="caption"><span class="caption-text">BTC-Relay Specification</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="btc-relay/data-model.html">Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="btc-relay/functions.html">Functions: Storage and Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="btc-relay/parser.html">Functions: Parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="btc-relay/helpers.html">Functions: Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="btc-relay/events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="btc-relay/errors.html">Error Codes</a></li>
</ul>
<p class="caption"><span class="caption-text">Security and Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/liquidations.html">Vault Liquidations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/xclaim-security.html">XCLAIM Security Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/btcrelay-security.html">Security Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/performance.html">Performance Analysis</a></li>
</ul>
<p class="caption"><span class="caption-text">Economics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../economics/incentives.html">Economic Incentives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../economics/fees.html">Fee Model</a></li>
</ul>
<p class="caption"><span class="caption-text">All the rest</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../other/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other/interlay.html">Interlay</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">interBTC Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Replace</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/spec/replace.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="replace">
<span id="replace-protocol"></span><h1>Replace<a class="headerlink" href="#replace" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The Replace module allows a Vault (<em>oldVault</em>) to be replaced by transferring the BTC it is holding locked to another Vault (<em>newVault</em>)
which provides the necessary DOT collateral. The DOT collateral of the <em>oldVault</em>, corresponding to the amount of replaced BTC, is then unlocked.
The <em>oldVault</em> must provide griefing collateral for spam protection which is paid to <em>newVault</em> on failure.</p>
<p>The <em>oldVault</em> is responsible for ensuring that it has sufficient BTC to pay for the transaction fees.</p>
<p>Conceptually, the Replace protocol resembles a SPV atomic cross-chain swap.</p>
<div class="section" id="step-by-step">
<h3>Step-by-Step<a class="headerlink" href="#step-by-step" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Precondition: a Vault (<em>oldVault</em>) has locked DOT collateral in the <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a> and has issued interBTC tokens - i.e., holds BTC on Bitcoin.</p></li>
<li><p><em>oldVault</em> submits a replace request, indicating how much BTC is to be migrated by calling the <a class="reference internal" href="#requestreplace"><span class="std std-ref">requestReplace</span></a> function.</p>
<ul class="simple">
<li><p><em>oldVault</em> is required to lock some amount of DOT collateral (<a class="reference internal" href="fee.html#replacegriefingcollateral"><span class="std std-ref">ReplaceGriefingCollateral</span></a>) as griefing protection, to prevent <em>oldVault</em> from holding <em>newVault</em>’s DOT collateral locked in the BTC Parachain without ever finalizing the redeem protocol (transfer of BTC).</p></li>
</ul>
</li>
<li><p>Optional: <em>oldVault</em> can withdraw the request by calling the <a class="reference internal" href="#withdrawreplace"><span class="std std-ref">withdrawReplace</span></a> function with a specified amount. For example, if <em>oldVault</em> requested a replacement for 10 tokens, and 2 tokens have been accepted by some <em>newVault</em>, then it can withdraw up to 8 tokens from being replaced.</p></li>
<li><p>A new candidate Vault (<em>newVault</em>), commits to accepting the replacement by locking up the necessary DOT collateral to back the to-be-transferred BTC (according to the <a class="reference internal" href="vault-registry.html#securecollateralthreshold"><span class="std std-ref">SecureCollateralThreshold</span></a>) by calling the <a class="reference internal" href="#acceptreplace"><span class="std std-ref">acceptReplace</span></a> function.</p>
<ul class="simple">
<li><p>Note: from the <em>oldVault</em>’s perspective a redeem is very similar to an accepted replace. That is, its goal is to get rid of tokens, and it is not important if this is achieved by a user redeeming, or by a Vault accepting the replace request. As such, when a user requests a redeem with a Vault that has requested a replacement, the <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> is decreased by the amount of tokens redeemed by the user.</p></li>
</ul>
</li>
<li><p>Within a pre-defined delay, <em>oldVault</em> must release the BTC on Bitcoin to <em>newVault</em>’s BTC address, and submit a valid transaction inclusion proof by calling the <a class="reference internal" href="#executereplace"><span class="std std-ref">executeReplace</span></a> function (call to <code class="docutils literal notranslate"><span class="pre">verifyTransactionInclusion</span></code> in <span class="xref std std-ref">btc-relay</span>). If <em>oldVault</em> releases the BTC to <em>newVault</em> correctly and submits the transaction inclusion proof to Replace module on time, <em>oldVault</em>’s DOT collateral is released - <em>newVault</em> has now replaced <em>oldVault</em>.</p>
<ul class="simple">
<li><p>Note: as with redeems, to prevent <em>oldVault</em> from trying to re-use old transactions (or other payments to <em>newVaults</em> on Bitcoin) as fake proofs, we require <em>oldVault</em> to include a <code class="docutils literal notranslate"><span class="pre">nonce</span></code> in an OP_RETURN output of the transfer transaction on Bitcoin.</p></li>
</ul>
</li>
<li><p>Optional: If <em>oldVault</em> fails to provide the correct transaction inclusion proof on time, the <em>newVault</em>’s <code class="docutils literal notranslate"><span class="pre">collateral</span></code> is unlocked and <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">griefingCollateral</span></code> is sent to the <em>newVault</em> as reimbursement for the opportunity costs of locking up DOT collateral via the <a class="reference internal" href="#cancelreplace"><span class="std std-ref">cancelReplace</span></a>.</p></li>
</ol>
</div>
<div class="section" id="security">
<h3>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Unique identification of Bitcoin payments: <a class="reference internal" href="../security_performance/xclaim-security.html#op-return"><span class="std std-ref">OP_RETURN</span></a></p></li>
</ul>
</div>
<div class="section" id="vault-registry">
<h3>Vault Registry<a class="headerlink" href="#vault-registry" title="Permalink to this headline">¶</a></h3>
<p>The data access and state changes to the <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a> are documented in <a class="reference internal" href="#fig-vault-registry-replace"><span class="std std-numref">Fig. 11</span></a> below.</p>
<div class="figure align-default" id="id17">
<span id="fig-vault-registry-replace"></span><img alt="Vault-Registry Replace" src="../_images/VaultRegistry-Replace.png" />
<p class="caption"><span class="caption-number">Fig. 11 </span><span class="caption-text">The replace module interacts with functions in the Vault-Registry to handle updating token balances of vaults. The green lines indicate an increase, the red lines a decrease.</span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="fee-model">
<h3>Fee Model<a class="headerlink" href="#fee-model" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>If a replace request is cancelled, the griefing collateral is transferred to the <em>newVault</em>.</p></li>
<li><p>If a replace request is executed, the griefing collateral is transferred to the <em>oldVault</em>.</p></li>
</ul>
</div>
</div>
<div class="section" id="data-model">
<h2>Data Model<a class="headerlink" href="#data-model" title="Permalink to this headline">¶</a></h2>
<div class="section" id="scalars">
<h3>Scalars<a class="headerlink" href="#scalars" title="Permalink to this headline">¶</a></h3>
<div class="section" id="replacebtcdustvalue">
<h4>ReplaceBtcDustValue<a class="headerlink" href="#replacebtcdustvalue" title="Permalink to this headline">¶</a></h4>
<p>The minimum amount a <em>newVault</em> can accept - this is to ensure the <em>oldVault</em> is able to make the Bitcoin transfer. Furthermore, it puts a limit on the transaction fees that the <em>oldVault</em> needs to pay.</p>
</div>
<div class="section" id="replaceperiod">
<span id="id1"></span><h4>ReplacePeriod<a class="headerlink" href="#replaceperiod" title="Permalink to this headline">¶</a></h4>
<p>The time difference between a replace request is accepted by another Vault and the transfer of BTC (and submission of the transaction inclusion proof) by the to-be-replaced Vault. Concretely, this period is the amount by which <a class="reference internal" href="security.html#activeblockcount"><span class="std std-ref">ActiveBlockCount</span></a> is allowed to increase before the redeem is considered to be expired. The replace period has an upper limit to prevent griefing of Vault collateral. Each accepted replace request records the value of this field upon creation, and when checking the expiry, the maximum of the current ReplacePeriod and the value as recorded in the ReplaceRequest is used. This way, vaults are not negatively impacted by a change in the value.</p>
</div>
</div>
<div class="section" id="maps">
<h3>Maps<a class="headerlink" href="#maps" title="Permalink to this headline">¶</a></h3>
<div class="section" id="replacerequests">
<h4>ReplaceRequests<a class="headerlink" href="#replacerequests" title="Permalink to this headline">¶</a></h4>
<p>Vaults create replace requests if they want to have (a part of) their DOT collateral to be replaced by other Vaults. This mapping provides access from a unique hash <code class="docutils literal notranslate"><span class="pre">ReplaceId</span></code> to a <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> struct. <code class="docutils literal notranslate"><span class="pre">&lt;ReplaceId,</span> <span class="pre">Replace&gt;</span></code>.</p>
</div>
</div>
<div class="section" id="structs">
<h3>Structs<a class="headerlink" href="#structs" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id2">
<h4>Replace<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Stores the status and information about a single replace request.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 8%" />
<col style="width: 4%" />
<col style="width: 88%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code></p></td>
<td><p>AccountId</p></td>
<td><p>Account of the <em>oldVault</em> that is to be replaced.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">newVault</span></code></p></td>
<td><p>AccountId</p></td>
<td><p>Account of the <em>newVault</em>, which accepts the replace request.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">amount</span></code></p></td>
<td><p>interBTC</p></td>
<td><p>Amount of BTC / interBTC to be replaced.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">griefingCollateral</span></code></p></td>
<td><p>DOT</p></td>
<td><p>Griefing protection collateral locked by <em>oldVault</em>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">collateral</span></code></p></td>
<td><p>DOT</p></td>
<td><p>Collateral locked by the new Vault.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">acceptTime</span></code></p></td>
<td><p>BlockNumber</p></td>
<td><p>The <a class="reference internal" href="security.html#activeblockcount"><span class="std std-ref">ActiveBlockCount</span></a> when the replace request was accepted by a new Vault. Serves as start for the countdown until when the old Vault must transfer the BTC.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">period</span></code></p></td>
<td><p>BlockNumber</p></td>
<td><p>Value of <a class="reference internal" href="#replaceperiod"><span class="std std-ref">ReplacePeriod</span></a> when the redeem request was made, in case that value changes while this replace is pending.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">btcAddress</span></code></p></td>
<td><p>BtcAddress</p></td>
<td><p>Vault’s Bitcoin payment address.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">btcHeight</span></code></p></td>
<td><p>u32</p></td>
<td><p>Height of newest bitcoin block in the relay at the time the request is accepted. This is used by the clients upon startup, to determine how many blocks of the bitcoin chain they need to inspect to know if a payment has been made already.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">status</span></code></p></td>
<td><p>Enum</p></td>
<td><p>Status of the request: Pending, Completed or Cancelled</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="requestreplace">
<span id="id3"></span><h3>requestReplace<a class="headerlink" href="#requestreplace" title="Permalink to this headline">¶</a></h3>
<p>The <em>oldVault</em> (to-be-replaced) submits a request to be (partially) replaced. If it requests more than it can fulfil (i.e. the sum of <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> and <code class="docutils literal notranslate"><span class="pre">toBeRedeemedTokens</span></code> exceeds its <code class="docutils literal notranslate"><span class="pre">issuedTokens</span></code>, then the request amount is reduced such that the sum of <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> and <code class="docutils literal notranslate"><span class="pre">toBeRedeemedTokens</span></code> is exactly equal to <code class="docutils literal notranslate"><span class="pre">issuedTokens</span></code>.</p>
<div class="section" id="specification">
<h4>Specification<a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">requestReplace(oldVault,</span> <span class="pre">btcAmount,</span> <span class="pre">griefingCollateral)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the Vault to be replaced (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">btcAmount</span></code>: Integer amount of BTC / interBTC to be replaced.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">griefingCollateral</span></code>: collateral locked by the <em>oldVault</em> as griefing protection.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#requestreplaceevent"><span class="std std-ref">RequestReplace</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The function call MUST be signed by <em>oldVault</em>.</p></li>
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST be set to <code class="docutils literal notranslate"><span class="pre">RUNNING:0</span></code>.</p></li>
<li><p>The <em>oldVault</em> MUST be registered.</p></li>
<li><p>The <em>oldVault</em> MUST NOT be banned.</p></li>
<li><p>The <em>oldVault</em> MUST NOT be nominated (if <a class="reference internal" href="nomination.html#vault-nomination"><span class="std std-ref">Vault Nomination</span></a> is enabled).</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">btcAmount</span></code> is greater than the Vault’s <code class="docutils literal notranslate"><span class="pre">replacableTokens</span> <span class="pre">=</span> <span class="pre">issuedTokens</span> <span class="pre">-</span> <span class="pre">toBeRedeemTokens</span> <span class="pre">-</span> <span class="pre">toBeReplaceTokens</span></code>, set the <code class="docutils literal notranslate"><span class="pre">btcAmount</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">``replaceableTokens</span></code> amount.</p></li>
<li><p>The <em>oldVault</em> MUST provide sufficient <code class="docutils literal notranslate"><span class="pre">griefingCollateral</span></code> such that the ratio of all of its <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> and <code class="docutils literal notranslate"><span class="pre">replaceCollateral</span></code> is above <a class="reference internal" href="fee.html#replacegriefingcollateral"><span class="std std-ref">ReplaceGriefingCollateral</span></a>.</p></li>
<li><p>The <em>oldVault</em> MUST request sufficient <code class="docutils literal notranslate"><span class="pre">btcAmount</span></code> to be replaced such that its total is above <code class="docutils literal notranslate"><span class="pre">ReplaceBtcDustValue</span></code>.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> MUST be increased by <code class="docutils literal notranslate"><span class="pre">tokenIncrease</span> <span class="pre">=</span> <span class="pre">min(btcAmount,</span> <span class="pre">vault.toBeIssuedTokens</span> <span class="pre">-</span> <span class="pre">vault.toBeRedeemedTokens)</span></code>.</p></li>
<li><p>An amount of <code class="docutils literal notranslate"><span class="pre">griefingCollateral</span> <span class="pre">*</span> <span class="pre">(tokenIncrease</span> <span class="pre">/</span> <span class="pre">btcAmount)</span></code> MUST be locked by this transaction.</p></li>
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">replaceCollateral</span></code> MUST be increased by the amount of collateral locked in this transaction.</p></li>
</ul>
</div>
</div>
<div class="section" id="withdrawreplace">
<span id="id4"></span><h3>withdrawReplace<a class="headerlink" href="#withdrawreplace" title="Permalink to this headline">¶</a></h3>
<p>The <em>oldVault</em> decreases its <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code>.</p>
<div class="section" id="id5">
<h4>Specification<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">withdrawReplace(oldVault,</span> <span class="pre">tokens)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the Vault withdrawing it’s replace request (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tokens</span></code>: The amount of <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> to withdraw.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#withdrawreplaceevent"><span class="std std-ref">WithdrawReplace</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The function call MUST be signed by <em>oldVault</em>.</p></li>
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST NOT be set to <code class="docutils literal notranslate"><span class="pre">SHUTDOWN:</span> <span class="pre">2</span></code>.</p></li>
<li><p>The <em>oldVault</em> MUST be registered.</p></li>
<li><p>The <em>oldVault</em> MUST have a non-zero amount of <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code>.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> MUST decrease by an amount of <code class="docutils literal notranslate"><span class="pre">tokenDecrease</span> <span class="pre">=</span> <span class="pre">min(toBeReplacedTokens,</span> <span class="pre">tokens)</span></code></p></li>
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">replaceCollateral</span></code> MUST decreased by the amount <code class="docutils literal notranslate"><span class="pre">releasedCollateral</span> <span class="pre">=</span> <span class="pre">replaceCollateral</span> <span class="pre">*</span> <span class="pre">(tokenDecrease</span> <span class="pre">/</span> <span class="pre">toBeReplacedTokens)</span></code>.</p></li>
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">releasedCollateral</span></code> MUST be unlocked.</p></li>
</ul>
</div>
</div>
<div class="section" id="acceptreplace">
<span id="id6"></span><h3>acceptReplace<a class="headerlink" href="#acceptreplace" title="Permalink to this headline">¶</a></h3>
<p>A <em>newVault</em> accepts an existing replace request. It can optionally lock additional DOT collateral specifically for this replace. If the replace is cancelled, this amount will be unlocked again.</p>
<div class="section" id="id7">
<h4>Specification<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">acceptReplace(oldVault,</span> <span class="pre">newVault,</span> <span class="pre">btcAmount,</span> <span class="pre">collateral,</span> <span class="pre">btcAddress)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the <em>oldVault</em> who requested replacement (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">newVault</span></code>: Account identifier of the <em>newVault</em> accepting the replace request (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">replaceId</span></code>: The identifier of the replace request in <code class="docutils literal notranslate"><span class="pre">ReplaceRequests</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collateral</span></code>: DOT collateral provided to match the replace request (i.e., for backing the locked BTC). Can be more than the necessary amount.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">btcAddress</span></code>: The <em>newVault</em>’s Bitcoin payment address for transaction verification.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#acceptreplaceevent"><span class="std std-ref">AcceptReplace</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The function call MUST be signed by <em>newVault</em>.</p></li>
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST NOT be set to <code class="docutils literal notranslate"><span class="pre">SHUTDOWN:</span> <span class="pre">2</span></code>.</p></li>
<li><p>The <em>oldVault</em> and <em>newVault</em> MUST be registered.</p></li>
<li><p>The <em>oldVault</em> MUST NOT be equal to <em>newVault</em>.</p></li>
<li><p>The <em>newVault</em>’s free balance MUST be enough to lock <code class="docutils literal notranslate"><span class="pre">collateral</span></code>.</p></li>
<li><p>The <em>newVault</em> MUST have lock sufficient collateral to remain above the <a class="reference internal" href="vault-registry.html#securecollateralthreshold"><span class="std std-ref">SecureCollateralThreshold</span></a> after accepting <code class="docutils literal notranslate"><span class="pre">btcAmount</span></code>.</p></li>
<li><p>The <em>newVault</em>’s <code class="docutils literal notranslate"><span class="pre">btcAddress</span></code> MUST NOT be registered.</p></li>
<li><p>The replaced tokens MUST be at least``ReplaceBtcDustValue``.</p></li>
</ul>
<p><em>Postconditions</em></p>
<p>The actual amount of replaced tokens is calculated to be <code class="docutils literal notranslate"><span class="pre">consumedTokens</span> <span class="pre">=</span> <span class="pre">min(oldVault.toBeReplacedTokens,</span> <span class="pre">btcAmount)</span></code>. The amount of griefingCollateral used is <code class="docutils literal notranslate"><span class="pre">consumedGriefingCollateral</span> <span class="pre">=</span> <span class="pre">oldVault.replaceCollateral</span> <span class="pre">*</span> <span class="pre">(consumedTokens</span> <span class="pre">/</span> <span class="pre">oldVault.toBeReplacedTokens)</span></code>.</p>
<ul class="simple">
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">replaceCollateral</span></code> MUST be decreased by <code class="docutils literal notranslate"><span class="pre">consumedGriefingCollateral</span></code>.</p></li>
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> MUST be decreased by <code class="docutils literal notranslate"><span class="pre">consumedTokens</span></code>.</p></li>
<li><p>The <em>oldVault</em>’s <code class="docutils literal notranslate"><span class="pre">toBeRedeemedTokens</span></code> MUST be increased by <code class="docutils literal notranslate"><span class="pre">consumedTokens</span></code>.</p></li>
<li><p>The <em>newVault</em>’s <code class="docutils literal notranslate"><span class="pre">toBeIssuedTokens</span></code> MUST be increased by <code class="docutils literal notranslate"><span class="pre">consumedTokens</span></code>.</p></li>
<li><p>The <em>newVault</em> locks additional collateral; its <code class="docutils literal notranslate"><span class="pre">backingCollateral</span></code> MUST be increased by <code class="docutils literal notranslate"><span class="pre">collateral</span> <span class="pre">*</span> <span class="pre">(consumedTokens</span> <span class="pre">/</span> <span class="pre">oldVault.toBeReplacedTokens)</span></code>.</p></li>
<li><p>A unique <cite>replaceId</cite> must be generated from <a class="reference internal" href="security.html#generatesecureid"><span class="std std-ref">generateSecureId</span></a>.</p></li>
<li><p>A new <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> MUST be added to the replace request mapping at the <cite>replaceId</cite> key.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: MUST be the <code class="docutils literal notranslate"><span class="pre">oldVault</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">newVault</span></code>: MUST be the <code class="docutils literal notranslate"><span class="pre">newVault</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">amount</span></code>: MUST be``consumedTokens``.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">griefingCollateral</span></code>: MUST be <code class="docutils literal notranslate"><span class="pre">consumedGriefingCollateral</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collateral</span></code>: MUST be <code class="docutils literal notranslate"><span class="pre">collateral</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accept_time</span></code>: MUST be the current active block number.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">period</span></code>: MUST be the current <code class="docutils literal notranslate"><span class="pre">ReplacePeriod</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">btcAddress</span></code>: MUST be the <code class="docutils literal notranslate"><span class="pre">btcAddress</span></code> argument.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">btcHeight</span></code>: UST be the current height of the btc-relay.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">status</span></code>: MUST be <code class="docutils literal notranslate"><span class="pre">pending</span></code>.</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="executereplace">
<span id="id8"></span><h3>executeReplace<a class="headerlink" href="#executereplace" title="Permalink to this headline">¶</a></h3>
<p>The to-be-replaced Vault finalizes the replace process by submitting a proof that it transferred the correct amount of BTC to the BTC address of the new Vault, as specified in the <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code>. This function calls <em>verifyAndValidateTransaction</em> in <span class="xref std std-ref">btc-relay</span>.</p>
<div class="section" id="id9">
<h4>Specification<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">executeReplace(replaceId,</span> <span class="pre">rawMerkleProof,</span> <span class="pre">rawTx)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">replaceId</span></code>: The identifier of the replace request in <code class="docutils literal notranslate"><span class="pre">ReplaceRequests</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rawMerkleProof</span></code>: Raw Merkle tree path (concatenated LE SHA256 hashes).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rawTx</span></code>: Raw Bitcoin transaction including the transaction inputs and outputs.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#executereplaceevent"><span class="std std-ref">ExecuteReplace</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST NOT be set to <code class="docutils literal notranslate"><span class="pre">SHUTDOWN:2</span></code>.</p></li>
<li><p>Both <em>oldVault</em> and <em>newVault</em> (as specified in the request) MUST be registered in the <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>.</p></li>
<li><p>A pending <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> MUST exist with id <code class="docutils literal notranslate"><span class="pre">replaceId</span></code>.</p></li>
<li><p>The request MUST NOT have expired.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">rawTx</span></code> MUST decode to a valid transaction that transfers at least the amount specified in the <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> struct. It MUST be a transaction to the correct address, and provide the expected OP_RETURN, based on the <code class="docutils literal notranslate"><span class="pre">replaceId</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">rawMerkleProof</span></code> MUST contain a valid proof of of <code class="docutils literal notranslate"><span class="pre">rawTx</span></code>.</p></li>
<li><p>The Bitcoin payment MUST have been submitted to the relay chain, and MUST have sufficient confirmations.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul class="simple">
<li><p>The <a class="reference internal" href="vault-registry.html#replacetokens"><span class="std std-ref">replaceTokens</span></a> function in the <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a> MUST have been called, providing the <code class="docutils literal notranslate"><span class="pre">oldVault</span></code>, <code class="docutils literal notranslate"><span class="pre">newVault</span></code>, <code class="docutils literal notranslate"><span class="pre">replaceRequest.amount</span></code>, and <code class="docutils literal notranslate"><span class="pre">replaceRequest.collateral</span></code> as arguments.</p></li>
<li><p>The griefing collateral as specifified in the <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> MUST be released to the <em>oldVault</em>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">replaceRequest.status</span></code> MUST be set to <code class="docutils literal notranslate"><span class="pre">Completed</span></code>.</p></li>
</ul>
</div>
</div>
<div class="section" id="cancelreplace">
<span id="id10"></span><h3>cancelReplace<a class="headerlink" href="#cancelreplace" title="Permalink to this headline">¶</a></h3>
<p>If a replace request is not executed on time, the replace can be cancelled by the <em>newVault</em>. Since the <em>newVault</em> provided additional collateral in vain, it can claim the <em>oldVault</em>’s griefing collateral.</p>
<div class="section" id="id11">
<h4>Specification<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">cancelReplace(newVault,</span> <span class="pre">replaceId)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">newVault</span></code>: Account identifier of the Vault accepting the replace request (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">replaceId</span></code>: The identifier of the replace request in <code class="docutils literal notranslate"><span class="pre">ReplaceRequests</span></code>.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#cancelreplaceevent"><span class="std std-ref">CancelReplace</span></a></p></li>
</ul>
<p><em>Preconditions</em></p>
<ul class="simple">
<li><p>The BTC Parachain status in the <a class="reference internal" href="security.html#security"><span class="std std-ref">Security</span></a> component MUST NOT be set to <code class="docutils literal notranslate"><span class="pre">SHUTDOWN:2</span></code>.</p></li>
<li><p>Both <em>oldVault</em> and <em>newVault</em> (as specified in the request) MUST be registered in the <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>.</p></li>
<li><p>A pending <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> MUST exist with id <code class="docutils literal notranslate"><span class="pre">replaceId</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">newVault</span></code> MUST be equal to the <em>newVault</em> specified in the <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code>.</p></li>
<li><p>The request MUST have expired.</p></li>
</ul>
<p><em>Postconditions</em></p>
<ul>
<li><p>The <a class="reference internal" href="vault-registry.html#cancelreplacetokens"><span class="std std-ref">cancelReplaceTokens</span></a> function in the <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a> MUST have been called, providing the <code class="docutils literal notranslate"><span class="pre">oldVault</span></code>, <code class="docutils literal notranslate"><span class="pre">newVault</span></code>, <code class="docutils literal notranslate"><span class="pre">replaceRequest.amount</span></code>, and <code class="docutils literal notranslate"><span class="pre">replaceRequest.amount</span></code> as arguments.</p></li>
<li><p>If <em>newVault</em> IS NOT liquidated:</p>
<blockquote>
<div><ul class="simple">
<li><p>The griefing collateral MUST be slashed from the <em>oldVault</em> to the <em>newVault</em>’s <code class="docutils literal notranslate"><span class="pre">backingCollateral</span></code>.</p></li>
<li><p>If unlocking <code class="docutils literal notranslate"><span class="pre">replaceRequest.collateral</span></code> does not put the collateralization rate of the <em>newVault</em> below <code class="docutils literal notranslate"><span class="pre">SecureCollateralThreshold</span></code>, the collateral MUST be unlocked and its <code class="docutils literal notranslate"><span class="pre">backingCollateral</span></code> MUST decrease by the same amount.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If <em>newVault</em> IS liquidated:</p>
<blockquote>
<div><ul class="simple">
<li><p>The griefing collateral MUST BE slashed from the <em>oldVault</em> to the <em>newVault</em>’s free balance.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">replaceRequest.status</span></code> MUST be set to <code class="docutils literal notranslate"><span class="pre">Cancelled</span></code>.</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="events">
<h2>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h2>
<div class="section" id="requestreplaceevent">
<span id="id12"></span><h3>RequestReplace<a class="headerlink" href="#requestreplaceevent" title="Permalink to this headline">¶</a></h3>
<p>Emit an event when a replace request is made by an <em>oldVault</em>.</p>
<p><em>Event Signature</em>
* <code class="docutils literal notranslate"><span class="pre">RequestReplace(oldVault,</span> <span class="pre">btcAmount,</span> <span class="pre">replaceId)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the Vault to be replaced (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">btcAmount</span></code>: Integer amount of BTC / interBTC to be replaced.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">replaceId</span></code>: The unique identified of a replace request.</p></li>
</ul>
<p><em>Functions</em></p>
<ul class="simple">
<li><p><a class="reference internal" href="#requestreplace"><span class="std std-ref">requestReplace</span></a></p></li>
</ul>
</div>
<div class="section" id="withdrawreplaceevent">
<span id="id13"></span><h3>WithdrawReplace<a class="headerlink" href="#withdrawreplaceevent" title="Permalink to this headline">¶</a></h3>
<p>Emits an event stating that a Vault (<em>oldVault</em>) has withdrawn some amount of <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code>.</p>
<p><em>Event Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">WithdrawReplace(oldVault,</span> <span class="pre">withdrawnTokens,</span> <span class="pre">withdrawnGriefingCollateral)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the Vault requesting the replace (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">withdrawnTokens</span></code>: The amount by which <code class="docutils literal notranslate"><span class="pre">toBeReplacedTokens</span></code> has decreased.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">withdrawnGriefingCollateral</span></code>: The amount of griefing collateral unlocked.</p></li>
</ul>
<p><em>Functions</em></p>
<ul class="simple">
<li><p>ref:<cite>withdrawReplace</cite></p></li>
</ul>
</div>
<div class="section" id="acceptreplaceevent">
<span id="id14"></span><h3>AcceptReplace<a class="headerlink" href="#acceptreplaceevent" title="Permalink to this headline">¶</a></h3>
<p>Emits an event stating which Vault (<em>newVault</em>) has accepted the <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> request (<code class="docutils literal notranslate"><span class="pre">requestId</span></code>), and how much collateral in DOT it provided (<code class="docutils literal notranslate"><span class="pre">collateral</span></code>).</p>
<p><em>Event Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">AcceptReplace(replaceId,</span> <span class="pre">oldVault,</span> <span class="pre">newVault,</span> <span class="pre">btcAmount,</span> <span class="pre">collateral,</span> <span class="pre">btcAddress)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">replaceId</span></code>: The identifier of the replace request in <code class="docutils literal notranslate"><span class="pre">ReplaceRequests</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the Vault being replaced (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">newVault</span></code>: Account identifier of the Vault that accepted the replace request (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">btcAmount</span></code>: Amount of tokens the <em>newVault</em> just accepted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collateral</span></code>: Amount of collateral the <em>newVault</em> locked for this replace.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">btcAddress</span></code>: The address that <em>oldVault</em> should transfer the btc to.</p></li>
</ul>
<p><em>Functions</em></p>
<ul class="simple">
<li><p>ref:<cite>acceptReplace</cite></p></li>
</ul>
</div>
<div class="section" id="executereplaceevent">
<span id="id15"></span><h3>ExecuteReplace<a class="headerlink" href="#executereplaceevent" title="Permalink to this headline">¶</a></h3>
<p>Emits an event stating that the old Vault (<em>oldVault</em>) has executed the BTC transfer to the new Vault (<em>newVault</em>), finalizing the <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> request (<code class="docutils literal notranslate"><span class="pre">requestId</span></code>).</p>
<p><em>Event Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">ExecuteReplace(oldVault,</span> <span class="pre">newVault,</span> <span class="pre">replaceId)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the Vault being replaced (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">newVault</span></code>: Account identifier of the Vault that accepted the replace request (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">replaceId</span></code>: The identifier of the replace request in <code class="docutils literal notranslate"><span class="pre">ReplaceRequests</span></code>.</p></li>
</ul>
<p><em>Functions</em></p>
<ul class="simple">
<li><p>ref:<cite>executeReplace</cite></p></li>
</ul>
</div>
<div class="section" id="cancelreplaceevent">
<span id="id16"></span><h3>CancelReplace<a class="headerlink" href="#cancelreplaceevent" title="Permalink to this headline">¶</a></h3>
<p>Emits an event stating that the old Vault (<em>oldVault</em>) has not completed the replace request, that the new Vault (<em>newVault</em>) cancelled the <code class="docutils literal notranslate"><span class="pre">ReplaceRequest</span></code> request (<code class="docutils literal notranslate"><span class="pre">requestId</span></code>), and that <code class="docutils literal notranslate"><span class="pre">slashedCollateral</span></code> has been slashed from <em>oldVault</em> to <em>newVault</em>.</p>
<p><em>Event Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">CancelReplace(replaceId,</span> <span class="pre">newVault,</span> <span class="pre">oldVault,</span> <span class="pre">slashedCollateral)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">replaceId</span></code>: The identifier of the replace request in <code class="docutils literal notranslate"><span class="pre">ReplaceRequests</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oldVault</span></code>: Account identifier of the Vault being replaced (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">newVault</span></code>: Account identifier of the Vault that accepted the replace request (as tracked in <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> in <a class="reference internal" href="vault-registry.html#vault-registry"><span class="std std-ref">Vault Registry</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">slashedCollateral</span></code>: Amount of griefingCollateral slashed to <em>newVault</em>.</p></li>
</ul>
<p><em>Functions</em></p>
<ul class="simple">
<li><p>ref:<cite>cancelReplace</cite></p></li>
</ul>
</div>
</div>
<div class="section" id="error-codes">
<h2>Error Codes<a class="headerlink" href="#error-codes" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ERR_UNAUTHORIZED</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “Unauthorized: Caller must be <em>newVault</em>.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#cancelreplace"><span class="std std-ref">cancelReplace</span></a></p></li>
<li><p><strong>Cause</strong>: The caller of this function is not the associated <em>newVault</em>, and hence not authorized to take this action.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_INSUFFICIENT_COLLATERAL</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “The provided collateral is too low.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#requestreplace"><span class="std std-ref">requestReplace</span></a></p></li>
<li><p><strong>Cause</strong>: The provided collateral is insufficient to match the amount of tokens requested for replacement.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_REPLACE_PERIOD_EXPIRED</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “The replace period expired.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#executereplace"><span class="std std-ref">executeReplace</span></a></p></li>
<li><p><strong>Cause</strong>: The time limit as defined by the <code class="docutils literal notranslate"><span class="pre">ReplacePeriod</span></code> is not met.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_REPLACE_PERIOD_NOT_EXPIRED</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “The period to complete the replace request is not yet expired.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#cancelreplace"><span class="std std-ref">cancelReplace</span></a></p></li>
<li><p><strong>Cause</strong>:  A Vault tried to cancel a replace before it expired.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_AMOUNT_BELOW_BTC_DUST_VALUE</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “To be replaced amount is too small.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#requestreplace"><span class="std std-ref">requestReplace</span></a>, <a class="reference internal" href="#acceptreplace"><span class="std std-ref">acceptReplace</span></a></p></li>
<li><p><strong>Cause</strong>:  The Vault requests or accepts an insufficient number of tokens.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_NO_PENDING_REQUEST</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “Could not withdraw to-be-replaced tokens because it was already zero.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#requestreplace"><span class="std std-ref">requestReplace</span></a> | <a class="reference internal" href="#acceptreplace"><span class="std std-ref">acceptReplace</span></a></p></li>
<li><p><strong>Cause</strong>:  The Vault requests or accepts an insufficient number of tokens.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_REPLACE_SELF_NOT_ALLOWED</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “Vaults can not accept replace request created by themselves.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#acceptreplace"><span class="std std-ref">acceptReplace</span></a></p></li>
<li><p><strong>Cause</strong>:  A Vault tried to accept a replace that it itself had created.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_REPLACE_COMPLETED</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “Request is already completed.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#executereplace"><span class="std std-ref">executeReplace</span></a> | <a class="reference internal" href="#cancelreplace"><span class="std std-ref">cancelReplace</span></a></p></li>
<li><p><strong>Cause</strong>:  A Vault tried to operate on a request that already completed.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_REPLACE_CANCELLED</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “Request is already cancelled.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#executereplace"><span class="std std-ref">executeReplace</span></a> | <a class="reference internal" href="#cancelreplace"><span class="std std-ref">cancelReplace</span></a></p></li>
<li><p><strong>Cause</strong>:  A Vault tried to operate on a request that already cancelled.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_REPLACE_ID_NOT_FOUND</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “Invalid replace ID”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#executereplace"><span class="std std-ref">executeReplace</span></a> | <a class="reference internal" href="#cancelreplace"><span class="std std-ref">cancelReplace</span></a></p></li>
<li><p><strong>Cause</strong>:  An invalid replaceID was given - it is not found in the <code class="docutils literal notranslate"><span class="pre">ReplaceRequests</span></code> map.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ERR_VAULT_NOT_FOUND</span></code></p>
<ul class="simple">
<li><p><strong>Message</strong>: “The <code class="docutils literal notranslate"><span class="pre">Vault</span></code> cannot be found.”</p></li>
<li><p><strong>Function</strong>: <a class="reference internal" href="#requestreplace"><span class="std std-ref">requestReplace</span></a> | <a class="reference internal" href="#acceptreplace"><span class="std std-ref">acceptReplace</span></a> | <a class="reference internal" href="#cancelreplace"><span class="std std-ref">cancelReplace</span></a></p></li>
<li><p><strong>Cause</strong>: The Vault was not found in the existing <code class="docutils literal notranslate"><span class="pre">Vaults</span></code> list in <code class="docutils literal notranslate"><span class="pre">VaultRegistry</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible that functions in this pallet return errors defined in other pallets.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="security.html" class="btn btn-neutral float-right" title="Security" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="redeem.html" class="btn btn-neutral float-left" title="Redeem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Interlay

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>